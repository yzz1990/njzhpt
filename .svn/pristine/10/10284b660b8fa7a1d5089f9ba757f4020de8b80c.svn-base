<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>药剂出库信息</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta name="description" content="Blue Moon - Responsive Admin Dashboard">
    <meta name="keywords" content="Notifications, Admin, Dashboard, Bootstrap3, Sass, transform, CSS3, HTML5, Web design, UI Design, Responsive Dashboard, Responsive Admin, Admin Theme, Best Admin UI, Bootstrap Theme, Wrapbootstrap, Bootstrap, bootstrap.gallery">
    <meta name="author" content="Bootstrap Gallery">
    
    <!-- FONT AWESOME-->
	<link rel="stylesheet" href="${ctxPath}/css/font-awesome.min.css">

    <%include("/WEB-INF/web/ui/cssjs.html"){}%>
  </head>
<%
	var obj={},url=ctxPath+"/cangchugl/addYjck",title="新增药剂出库信息";
	if (isNotEmpty(parameter.id)) {
		var yjck = @com.zkzy.njzhpt.dao.CangchuglDao.findYjck({"id":parameter.id,"page":"1","rows":"100"});
		obj = yjck.list[0];
		url = ctxPath+"/cangchugl/upYjck";
		title = "编辑药剂出库信息";
	};
	
%>
<style>
.yaoji-table{
	border:1px solid;
	width:718px;
	margin-top: 10px;
}
.yaoji-table th,td{
	border:1px solid;
	text-align:center;
}
body{
 overflow-x : hidden;   
}

</style>
  <body>

        <div class="dashboard-wrapper-lg" style="padding: 0">
            <div class="row">
              <div class="col-lg-12 col-md-12">
                <div class="widget">
                  <div class="widget-header">
                    <div class="title">
                        	药剂申请信息                                        
                    </div>
                  </div>
                  <div class="widget-body">
				       <form id="contentform" role="form"  action="${url}" method="post" style="overflow: hidden;">
					       <input type="hidden" name="id" value="${obj.id}">
					       <input type="hidden" id="status" name="status" value="${obj.status}">
							<div class="row">
								<div class="col-xs-6">	
									<div class="form-group">
										<label for="lydw">备案企业:</label>
										<select id="lydw" name="lydw" class="form-control" onchange="getqiye()">
											<option value="">请选择</option>
										</select>
									</div>	
								</div>
								<div class="col-xs-6">	
									<div class="form-group">
										<label for="xzbah">备案编号:</label>
										<select id="xzbah" name="xzbah" class="form-control" onchange="getxinxi()">
											<option value="">请选择</option>
										</select>
									</div>	
								</div>
								
							</div>
							<div class="row">
								<div class="col-xs-6">	
									<div class="form-group">
										<label for="kdbm">熏蒸库点:</label>
										<select id="kdbm" name="kdbm" class="form-control" onchange="" disabled="disabled">
											<option value="">请选择</option>
										</select>
									</div>	
								</div>
								<div class="col-xs-6">	
									<div class="form-group">
										<label for="beianliuchen">备案流程:</label>
										<select id="beianliuchen"  class="form-control" onchange="" disabled="disabled">
											<option value="">请选择</option>
										</select>
									</div>	
								</div>
							</div>
							<div class="row">
								<!-- <div class="col-xs-6">	
									<div class="form-group">
										<label for="fangshi">熏蒸方式:</label>
										<select id="fangshi" class="form-control" onchange="" disabled="disabled">
											<option value="">请选择</option>
										</select>
									</div>	
								</div> -->
								<div class="col-xs-6">	
									<div class="form-group">
										<label for="fuzeren">熏蒸负责人:</label>
										<input id="fuzeren" class="form-control" placeholder="熏蒸负责人" value="${obj.fuzeren}" readonly="readonly">
									</div>	
								</div>
								<div class="col-xs-6">	
									<div class="form-group">
										<label for="lyrq">领药日期:</label>
										<input id="lyrq" name="lyrq" class="form-control" placeholder="领药日期" value="${obj.lyrq}" >
									</div>	
								</div>
							</div>
							<div class="row">
								
								<div class="col-xs-6">	
									<div class="form-group">
										<label for="lqr">领取人:</label>
										<input id="lqr" name="lqr" class="form-control" placeholder="领取人" value="${obj.lqr}">
									</div>	
								</div>
							</div>
							<div>
							<table id="cftable" class="table table-striped table-hover table-bordered datatables" >
								<thead>
									<tr>
										<th>序号</th>
										<th>药剂名称</th>
										<th>品牌</th>
										<th>规格</th>
										<th>单位</th>
										<th>厂家</th>
										<th>数量(瓶)</th>
									</tr>
								</thead>
							</table>
							<!-- <table class="yaoji-table">
								<thead>
									<tr>
										<th>序号</th>
										<th>药剂名称</th>
										<th>品牌</th>
										<th>规格</th>
										<th>单位</th>
										<th>厂家</th>
										<th>数量(瓶)</th>
									</tr>
								</thead>
								<tbody id="first">
									<tr >
										<td>1</td>
										<td>
											<input type="hidden" id="yjmc" name="yjmc" value="${obj.yjmc}">
					       					<input type="hidden" id="pp" name="pp" value="${obj.pp}">
					      					<input type="hidden" id="gg" name="gg" value="${obj.gg}">
					      					<input type="hidden" id="lysl" name="lysl" value="${obj.lysl}">
					      					<input type="hidden" id="dw" name="dw" value="${obj.dw}">
					      					<input type="hidden" id="sccj" name="sccj" value="${obj.sccj}">
											<select id="yaojim1"  style="width: 100%;height: 100%;border: 0" onchange="getpp()">
												<option value="">请选择</option>
											</select>
										</td>
										<td>
											<select id="pp1"  style="width: 100%;height: 100%;border: 0" onchange="getgg()" >
												<option value="">请选择</option>
											</select>
										</td>
										<td>
											<select id="gg1"  style="width: 100%;height: 100%;border: 0" onchange="getdw()" >
												<option value="">请选择</option>
											</select>
										</td>
										<td>
											<select id="dw1"  style="width: 100%;height: 100%;border: 0" onchange="getcj()">
												<option value="">请选择</option>
											</select>
										</td>
										<td>
											<select id="sccj1"  style="width: 100%;height: 100%;border: 0" >
												<option value="">请选择</option>
											</select>
										</td>
										<td>
											<input id="lysl1"  style="width: 100%;height: 100%;border: 0">
										</td>
									</tr>
								</tbody>
							</table> -->
							</div>
							<div class="row" style="margin-top: 20px;">
								<div class="col-xs-6">
									<div class="form-group">
										<label for="remark">附件:</label>
										<input id="fujianpath" name="fujianpath" type="hidden">
										<input id="fujianname" name="fujianname" type="hidden">
											<a class="btn btn-sm btn-info" style="font-size:1px" >
												<input  class="file_upload"  type="file"  />
											</a>
											<a id="scfilename" style="width: 270px;margin-top:4px; " ></a>
											<a id="tip-queue"  style="float:right;width:125px;display:none;"></a>
									</div>
								</div>
								
							</div>
					</form>
                  </div>
                </div>
	
                
              </div>
            </div>
            <!-- Row End -->
        </div>

<script type="text/javascript">
Array.prototype.S=String.fromCharCode(2);
Array.prototype.in_array=function(e){
    var r=new RegExp(this.S+e+this.S);
    return (r.test(this.S+this.join(this.S)+this.S));
};
$(function(){
$("#lyrq").datetimepicker({
		
		format : 'yyyy-mm-dd',
		language : 'zh-CN', //这里需要修改
		weekStart : 1,
		autoclose : 1,
		todayHighlight : 1,
		startView : 2,
		minView : 2,
		forceParse : 0
	});
	$("#xzqydm").select2();
	$("#lydw").select2();
	$("#xzbah").select2();
	$("#kdbm").select2();
	$("#beianliuchen").select2();
	$("#fangshi").select2();
	/* 企业组织机构代码初始化 */
	$.ajax({
		url:'${ctxPath}/lunhuan/selectQYMC.do',
		type:'post',
		data:{"name":"${array.contain(session.userinfo.auth,'auth_select_part')?session.userinfo.area.name:''}"
			,"qymc":"${array.contain(session.userinfo.auth,'auth_company')?session.userinfo.dep.name:''}"},
		dataType:'json',
		success: function(data) {
			$.each(data.list,function(i, n){
				if(n.qyzzjgdm=="${obj.qyzzjgdm}"){
					$("#lydw").append("<option value="+n.id+"  selected>"+n.qymc+"</option>");
				}else{
					$("#lydw").append("<option value="+n.id+">"+n.qymc+"</option>");
				}
			});
		},
		error:function(){
			//alert("error");
		}
	});
	/*药剂名称*/
	var ch=[];
	$.ajax({
		url:'${ctxPath}/renyuan/findyjkcxinxi',
		type:'post',
		data:{"page":1,"rows":1000},
		dataType:'json',
		success: function(data) {
			$.each(data.list,function(i, n){
				if(!ch.in_array(n.yjmc)){
					$("#yaojim1").append("<option value="+n.yjmc+">"+n.yjmc+"</option>");	
				}
				ch.push(n.yjmc);
			});
		},
		error:function(){
			//alert("error");
		}
	});
		
	$('.file_upload').uploadifive({
		'auto' : true,   //自动上传 
        'uploadScript' : '${ctxPath}/excel/uploadlhpzxwFile',  //处理上传文件Action路径
        'buttonClass' : 'file_upload',
        'fileObjName' : 'file',        //文件对象
  	    'buttonText'   : '上传附件',   //按钮显示文字 
  	 	'queueID'      : 'tip-queue', //提示信息放置目标 
  	    'onUploadComplete' : function(file, data) { //文件上传成功后执行
	    	var obj = JSON.parse(data);
	    	$("#scfilename").html(obj.scfilename);
	    	$("#fujianname").val(obj.scfilename);
	    	//alert(obj.filepath);
	    	$("#scfilename").attr("href","${ctxPath}"+obj.filepath);
	    	$("#scfilename").attr("download",obj.scfilename);
	    	$("#fujianpath").val(obj.filepath);
    	}
	});
	
});

//企业编码下拉框选择事件
function getqiye(){
	$("#xzbah").empty();
	$("#kdbm").empty();
	$("#beianliuchen").empty();
	$("#fangshi").empty();
	$("#kdbm").append("<option value=''>请选择</option>");
	$("#beianliuchen").append("<option value=''>请选择</option>");
	$("#fangshi").append("<option value=''>请选择</option>");
	$("#fuzeren").val("");
	var id = $("#lydw option:selected").val();
	$("#xzbah").append("<option value=''>请选择</option>");
	/*库点编码初始化 */
	$.ajax({
		url: "${ctxPath}/renyuan/findXunztg",
		dataType: "json",
		data:{qiyeid:id},
		success: function(data) {
			$.each(data.list,function(i, n){
				if(n.jiedian!=undefined){
					if(n.status>n.jiedian){
						$.ajax({
							url: "${ctxPath}/cangchugl/findYjck",
							dataType: "json",
							data:{"xzbah":n.beianbianhao,"page":1,"rows":1000},
							success: function(data) {
								if(data.list.length==0){
									$("#xzbah").append("<option value="+n.beianbianhao+" >"+n.beianbianhao+"</option>");
								}
							}
						});
					}
				}
			});
		}
	});
}
var datatable;
function getxinxi(){
	var beianbianhao = $("#xzbah option:selected").val();
	if(beianbianhao==""){
		$("#kdbm").empty();
		$("#beianliuchen").empty();
		$("#fangshi").empty();
		$("#kdbm").append("<option value=''>请选择</option>");
		$("#beianliuchen").append("<option value=''>请选择</option>");
		$("#fangshi").append("<option value=''>请选择</option>");
		$("#fuzeren").val("");
	}else{
		$.ajax({
			url: "${ctxPath}/renyuan/findXunztg",
			dataType: "json",
			data:{beianbianhao:beianbianhao},
			success: function(data) {
				$.each(data.list,function(i, n){
					huoqukd(n.kudian);
					$("#beianliuchen").append("<option value="+n.liuchenghao+" selected>"+n.liuchenghao+"</option>");
					$("#fangshi").append("<option value="+n.fangshi+" selected>"+n.fangshi+"</option>");
					$("#fuzeren").val(n.fuzeren);
						
				});
			}
		});
		$("#cftable").attr("data-url","${ctxPath}/cangchugl/findYjckxx?beianbianhao="+beianbianhao+"");
		if(datatable==null){
			datatable = $('.datatables').DataTable({
				"columns": [
					{
						"data":"xuhao",width:40,
						"title":"序号"
					},
					{
						"data" : "yjmc",width:50,
						"title" : "药剂名称"
					},{
						"data" : "pp",width:50,
						"title" : "品牌"
					},{
						"data" : "gg",width:50,
						"title" : "规格",
					},{
						"data" : "dw",width:50,
						"title" : "单位",
					},{
						"data" : "sccj",width:60,
						"title" : "厂家",
					},{
						"data" : "lysl",width:60,
						"title" : "数量(瓶)"
					}
					]
			});
		}else{
			datatable.ajax.reload(null,true);
		}

	}
}
function huoqukd(kudian){
	$.ajax({
		url: "${ctxPath}/lunhuan/selectKDMC.do",
		dataType: "json",
		data:{"name":"${array.contain(session.userinfo.auth,'auth_select_part')?session.userinfo.area.name:''}"
			,"qymc":"${array.contain(session.userinfo.auth,'auth_company')?session.userinfo.dep.name:''}"},
		success: function(data) {
			$.each(data.list,function(i, n){
				if(n.kdbm==kudian){
					$("#kdbm").append("<option value="+n.kdbm+"  selected>"+n.kdmc+"</option>");
				}
			});
		}
	});
}
function saveYjck() {
	if($("#lydw").val()==""){
		alert("请选择备案企业!");
		return false;
	}else if($("#xzbah").val()==""){
		alert("请选择熏蒸备案号!")
		return false;
	}else if($("#lyrq").val()==""){
		alert("请选择领药日期!")
		return false;
	}else if($("#lqr").val()==""){
		alert("请输入领取人!")
		return false;
	}
	
	$("#status").val("1");
	 var form = $(".widget-body form");
	$.ajax({
		url: form.attr("action"),
		dataType: "json",
		data: form.serialize(),
		success: function(msg) {
			if (!msg.ret) {
				alert(msg.message);
			} else {
				parent.window.dialog1.close();
				alert("保存成功");
			}
		}
	}); 
}

</script>

</body>
</html>